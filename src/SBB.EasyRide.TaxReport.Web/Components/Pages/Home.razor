@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Identity.Web
@using SBB.EasyRide.TaxReport.Infrastructure.Services
@using SBB.EasyRide.TaxReport.Infrastructure.Models
@using SBB.EasyRide.TaxReport.Web.Services
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ITokenAcquisition TokenAcquisition
@inject IEmailService EmailService
@inject StartupService StartupService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<h1>SBB EasyRide – Tax Report</h1>

<hr />

<h3>Authentication</h3>

@if (!isLoaded)
{
    <p>Loading...</p>
}
else if (isAuthenticated)
{
    <p>Welcome, @userName!</p>
    <button class="btn btn-secondary" @onclick="HandleLogout">Logout</button>
}
else
{
    <form method="get" action="MicrosoftIdentity/Account/SignIn">
        <button type="submit" class="btn btn-primary">Login</button>
    </form>
}

<hr />

<h3>Report Date Selection</h3>

<!-- DATE MODE TOGGLE -->
<div class="mb-3">
    <label class="form-label">Select date mode</label>

    <div class="d-flex gap-4">
        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Year")"
                   @onclick="@(() => dateMode = "Year")" />
            <label class="form-check-label">Year</label>
        </div>

        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Range")"
                   @onclick="@(() => dateMode = "Range")" />
            <label class="form-check-label">Specific date range</label>
        </div>
    </div>
</div>

<!-- INPUTS -->
<div class="d-flex gap-5 align-items-start">

    <!-- YEAR -->
    <div>
        <label class="form-label" style="@(dateMode != "Year" ? "text-decoration: line-through;" : "")">Year</label>
        <select class="form-select"
                @bind="selectedYear"
                style="max-width: 200px;"
                disabled="@(dateMode != "Year")">
            @for (int year = DateTime.Now.Year; year >= 1980; year--)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>

    <!-- DATE RANGE -->
    <div>
        <label class="form-label" style="@(dateMode != "Range" ? "text-decoration: line-through;" : "")">Date range</label>
        <div class="d-flex gap-2">
            <input type="date"
                   @bind="startDate"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />

            <input type="date"
                   @bind="endDate"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />
        </div>
    </div>

</div>

<hr />

<h3>Mail Settings</h3>

<div class="mb-3">
    <label class="form-label">Mail address</label>
    <input type="email"
           class="form-control"
           style="max-width: 400px;" />

    <div class="form-text">
        Sender address to filter by (e.g. noreply@order.info.sbb.ch)
    </div>
</div>

<div class="mb-3">
    <label class="form-label">Mail subject</label>
    <input type="text"
           @bind="subjectFilter"
           class="form-control"
           style="max-width: 600px;"
           placeholder="e.g. EasyRide" />

    <div class="form-text">
        Subject contains this text (e.g. EasyRide Kaufquittung)
    </div>
</div>

<hr />

<h3>Search Results</h3>

@if (searchResults != null && searchResults.Any())
{
    <div class="alert alert-success">
        <strong>Found @searchResults.Count email(s)</strong>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Received Date</th>
                    <th>From</th>
                    <th>Subject</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var email in searchResults)
                {
                    <tr>
                        <td>@email.ReceivedDateTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@email.From</td>
                        <td>@email.Subject</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else if (searchResults != null)
{
    <div class="alert alert-warning">
        <strong>No emails found matching your criteria</strong>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

<button class="btn btn-primary" @onclick="SearchEmails" disabled="@(!isAuthenticated || isLoading)">
    @if (isLoading)
    {
        <span>Searching...</span>
    }
    else
    {
        <span>Search Emails</span>
    }
</button>

<hr />

<h3>Test: Get Last Email Subject</h3>

@if (!string.IsNullOrEmpty(testResult))
{
    <div class="alert alert-info">
        <strong>Last email subject:</strong> @testResult
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

<button class="btn btn-primary" @onclick="TestGetLastEmail" disabled="@(!isAuthenticated || isLoading)">
    @if (isLoading)
    {
        <span>Loading...</span>
    }
    else
    {
        <span>Test: Get Last Email</span>
    }
</button>

<hr />

<button class="btn btn-success btn-lg" disabled>
    Generate report (Coming soon)
</button>

@code {
    private string dateMode = "Year";
    private int selectedYear = DateTime.Now.Year;
    private DateOnly startDate = DateOnly.FromDateTime(DateTime.Now.AddMonths(-1));
    private DateOnly endDate = DateOnly.FromDateTime(DateTime.Now);
    private string subjectFilter = string.Empty;
    
    private bool isAuthenticated = false;
    private bool isLoaded = false;
    private string userName = string.Empty;
    private bool isLoading = false;
    private string testResult = string.Empty;
    private string errorMessage = string.Empty;
    private List<EmailSearchResult>? searchResults = null;

    protected override async Task OnInitializedAsync()
    {
        // Check if this is the first request after server restart
        if (StartupService.IsFirstRequestAfterStartup())
        {
            // Force logout to clear any stale authentication
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                Console.WriteLine("[Home] Server restart detected - forcing logout");
                Navigation.NavigateTo("Account/Logout", forceLoad: true);
                return;
            }
        }

        var authState2 = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState2.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userName = user.Identity?.Name ?? "Unknown";
        isLoaded = true;
    }

    private void HandleLogout()
    {
        Navigation.NavigateTo("Account/Logout", forceLoad: true);
    }

    private async Task TestGetLastEmail()
    {
        isLoading = true;
        testResult = string.Empty;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Step 1: Get access token for Microsoft Graph
            var scopes = new[] { "https://graph.microsoft.com/Mail.Read" };
            var accessToken = await TokenAcquisition.GetAccessTokenForUserAsync(scopes);

            // After getting the token, decode and log it
            Console.WriteLine($"[DEBUG] Full token: {accessToken}");

            // Step 2: Call our service with the token
            var subject = await EmailService.GetLastEmailSubjectAsync(accessToken);

            // Step 3: Display the result
            testResult = subject ?? "(No emails found)";
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SearchEmails()
    {
        isLoading = true;
        searchResults = null;
        errorMessage = string.Empty;
        testResult = string.Empty;
        StateHasChanged();

        try
        {
            // Calculate date range based on mode
            DateTime searchStart, searchEnd;
            
            if (dateMode == "Year")
            {
                searchStart = new DateTime(selectedYear, 1, 1);
                searchEnd = new DateTime(selectedYear, 12, 31, 23, 59, 59);
            }
            else
            {
                searchStart = startDate.ToDateTime(TimeOnly.MinValue);
                searchEnd = endDate.ToDateTime(new TimeOnly(23, 59, 59));
            }

            // Get access token
            var scopes = new[] { "https://graph.microsoft.com/Mail.Read" };
            var accessToken = await TokenAcquisition.GetAccessTokenForUserAsync(scopes);

            // Search emails
            searchResults = await EmailService.SearchEmailsAsync(
                accessToken, 
                searchStart, 
                searchEnd, 
                string.IsNullOrWhiteSpace(subjectFilter) ? null : subjectFilter
            );
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
