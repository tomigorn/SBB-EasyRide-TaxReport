@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Identity.Web
@using SBB.EasyRide.TaxReport.Infrastructure.Services
@using SBB.EasyRide.TaxReport.Web.Services
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ITokenAcquisition TokenAcquisition
@inject IEmailService EmailService
@inject StartupService StartupService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<h1>SBB EasyRide – Tax Report</h1>

<hr />

<h3>Authentication</h3>

@if (!isLoaded)
{
    <p>Loading...</p>
}
else if (isAuthenticated)
{
    <p>Welcome, @userName!</p>
    <button class="btn btn-secondary" @onclick="HandleLogout">Logout</button>
}
else
{
    <form method="get" action="MicrosoftIdentity/Account/SignIn">
        <button type="submit" class="btn btn-primary">Login</button>
    </form>
}

<hr />

<h3>Report Date Selection</h3>

<!-- DATE MODE TOGGLE -->
<div class="mb-3">
    <label class="form-label">Select date mode</label>

    <div class="d-flex gap-4">
        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Year")"
                   @onclick="@(() => dateMode = "Year")" />
            <label class="form-check-label">Year</label>
        </div>

        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Range")"
                   @onclick="@(() => dateMode = "Range")" />
            <label class="form-check-label">Specific date range</label>
        </div>
    </div>
</div>

<!-- INPUTS -->
<div class="d-flex gap-5 align-items-start">

    <!-- YEAR -->
    <div>
        <label class="form-label" style="@(dateMode != "Year" ? "text-decoration: line-through;" : "")">Year</label>
        <select class="form-select"
                style="max-width: 200px;"
                disabled="@(dateMode != "Year")">
            @for (int year = DateTime.Now.Year; year >= 1980; year--)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>

    <!-- DATE RANGE -->
    <div>
        <label class="form-label" style="@(dateMode != "Range" ? "text-decoration: line-through;" : "")">Date range</label>
        <div class="d-flex gap-2">
            <input type="date"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />

            <input type="date"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />
        </div>
    </div>

</div>

<hr />

<h3>Mail Settings</h3>

<div class="mb-3">
    <label class="form-label">Mail address</label>
    <input type="email"
           class="form-control"
           style="max-width: 400px;" />

    <div class="form-text">
        Sender address to filter by (e.g. noreply@order.info.sbb.ch)
    </div>
</div>

<div class="mb-3">
    <label class="form-label">Mail subject</label>
    <input type="text"
           class="form-control"
           style="max-width: 600px;" />

    <div class="form-text">
        Subject contains this text (e.g. EasyRide Kaufquittung)
    </div>
</div>

<hr />

<h3>Test: Get Last Email Subject</h3>

@if (!string.IsNullOrEmpty(testResult))
{
    <div class="alert alert-info">
        <strong>Last email subject:</strong> @testResult
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

<button class="btn btn-primary" @onclick="TestGetLastEmail" disabled="@(!isAuthenticated || isLoading)">
    @if (isLoading)
    {
        <span>Loading...</span>
    }
    else
    {
        <span>Test: Get Last Email</span>
    }
</button>

<hr />

<button class="btn btn-success btn-lg">
    Generate report
</button>

@code {
    private string dateMode = "Year"; // default
    private bool isAuthenticated = false;
    private bool isLoaded = false;
    private string userName = string.Empty;
    private bool isLoading = false;
    private string testResult = string.Empty;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // Check if this is the first request after server restart
        if (StartupService.IsFirstRequestAfterStartup())
        {
            // Force logout to clear any stale authentication
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                Console.WriteLine("[Home] Server restart detected - forcing logout");
                Navigation.NavigateTo("Account/Logout", forceLoad: true);
                return;
            }
        }

        var authState2 = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState2.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userName = user.Identity?.Name ?? "Unknown";
        isLoaded = true;
    }

    private void HandleLogout()
    {
        Navigation.NavigateTo("Account/Logout", forceLoad: true);
    }

    private async Task TestGetLastEmail()
    {
        isLoading = true;
        testResult = string.Empty;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Step 1: Get access token for Microsoft Graph
            var scopes = new[] { "https://graph.microsoft.com/Mail.Read" };
            var accessToken = await TokenAcquisition.GetAccessTokenForUserAsync(scopes);

            // After getting the token, decode and log it
            Console.WriteLine($"[DEBUG] Full token: {accessToken}");

            // Step 2: Call our service with the token
            var subject = await EmailService.GetLastEmailSubjectAsync(accessToken);

            // Step 3: Display the result
            testResult = subject ?? "(No emails found)";
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
