@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Identity.Web
@using SBB.EasyRide.TaxReport.Infrastructure.Services
@using SBB.EasyRide.TaxReport.Infrastructure.Models
@using SBB.EasyRide.TaxReport.Web.Services
@using System.Text
@using Microsoft.JSInterop
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ITokenAcquisition TokenAcquisition
@inject IEmailService EmailService
@inject StartupService StartupService
@inject IJSRuntime JSRuntime
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<h1>SBB EasyRide – Tax Report</h1>

<hr />

<h3>Authentication</h3>

@if (!isLoaded)
{
    <p>Loading...</p>
}
else if (isAuthenticated)
{
    <p>Mail used for search: @userName</p>
    <button class="btn btn-secondary" @onclick="HandleLogout">Logout</button>
}
else
{
    <form method="get" action="MicrosoftIdentity/Account/SignIn">
        <button type="submit" class="btn btn-primary">Login</button>
    </form>
}

<hr />

<h3>Report Date Selection</h3>

<!-- DATE MODE TOGGLE -->
<div class="mb-3">
    <label class="form-label">Select date mode</label>

    <div class="d-flex gap-4">
        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Year")"
                   @onclick="@(() => dateMode = "Year")" />
            <label class="form-check-label">Year</label>
        </div>

        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Range")"
                   @onclick="@(() => dateMode = "Range")" />
            <label class="form-check-label">Specific date range</label>
        </div>
    </div>
</div>

<!-- INPUTS -->
<div class="d-flex gap-5 align-items-start">

    <!-- YEAR -->
    <div>
        <label class="form-label" style="@(dateMode != "Year" ? "text-decoration: line-through;" : "")">Year</label>
        <select class="form-select"
                @bind="selectedYear"
                style="max-width: 200px;"
                disabled="@(dateMode != "Year")">
            @for (int year = DateTime.Now.Year; year >= 1980; year--)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>

    <!-- DATE RANGE -->
    <div>
        <label class="form-label" style="@(dateMode != "Range" ? "text-decoration: line-through;" : "")">Date range</label>
        <div class="d-flex gap-2">
            <input type="date"
                   @bind="startDate"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />

            <input type="date"
                   @bind="endDate"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />
        </div>
    </div>

</div>

<hr />

<h3>Mail Settings</h3>

<div class="mb-3">
    <label class="form-label">Mail subject filters</label>
    <div class="input-group" style="max-width: 600px;">
        <input type="text"
               @bind="subjectFilterInput"
               @bind:event="oninput"
               @onkeypress="HandleKeyPress"
               class="form-control"
               placeholder="e.g. EasyRide, Ihr Online-Kauf" />
        <button class="btn btn-primary" @onclick="AddSubjectFilter" disabled="@string.IsNullOrWhiteSpace(subjectFilterInput)">
            Add
        </button>
    </div>
    <div class="form-text">
        Add subjects to search for (emails matching ANY of these will be included) <br/>
        <button class="btn btn-sm btn-outline-secondary mt-1" @onclick="AddDefaultFilters">
            Add common filters: @string.Join(", ", defaultFilters)
        </button>
    </div>
</div>

@if (subjectFilters.Any())
{
    <div class="mb-3">
        <label class="form-label">Active filters:</label>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var filter in subjectFilters)
            {
                <span class="badge bg-secondary d-flex align-items-center gap-2" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                    @filter
                    <button type="button" class="btn-close btn-close-white" style="font-size: 0.7rem;" @onclick="() => RemoveSubjectFilter(filter)" aria-label="Remove"></button>
                </span>
            }
        </div>
    </div>
}

<hr />

<button class="btn btn-primary" @onclick="SearchEmails" disabled="@(!isAuthenticated || isLoading)">
    @if (isLoading)
    {
        <span>Searching...</span>
    }
    else
    {
        <span>Search Emails</span>
    }
</button>

<hr />

<h3>Search Results</h3>

@if (searchResults != null && searchResults.Any())
{
    <div class="alert alert-success">
        <strong>Found @searchResults.Count email(s)</strong>
    </div>
    
    <div class="mb-3">
        <button class="btn btn-success" @onclick="GenerateCsv" disabled="@(isLoading || isPdfGenerating)">
            Download CSV Report
        </button>
        <button class="btn btn-primary ms-2" @onclick="GeneratePdf" disabled="@(isLoading || isPdfGenerating)">
            @if (isPdfGenerating)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Generating PDF...</span>
            }
            else
            {
                <span>Generate Merged PDF Report</span>
            }
        </button>
    </div>
    
    @if (isPdfGenerating)
    {
        <div class="alert alert-info" role="alert">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>
                    <strong>Generating PDF report...</strong><br/>
                    <small>Processing @searchResults?.Count email(s) and merging PDF attachments. This may take a moment.</small>
                </div>
            </div>
        </div>
    }
    
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Received Date</th>
                    <th>Transaction Date</th>
                    <th>From</th>
                    <th>Subject</th>
                    <th>Amount (CHF)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var email in searchResults)
                {
                    <tr>
                        <td>@email.ReceivedDateTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td>@(email.TransactionDate ?? "-")</td>
                        <td>@email.From</td>
                        <td>@email.Subject</td>
                        <td>@(email.Amount ?? "-")</td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="4" class="text-end">Total:</th>
                    <th>CHF @CalculateTotal()</th>
                </tr>
            </tfoot>
        </table>
    </div>
}
else if (searchResults != null)
{
    <div class="alert alert-warning">
        <strong>No emails found matching your criteria</strong>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

@code {
    private readonly string[] defaultFilters = new[] 
    {
        "Ihr Abo-Kauf im ZVV-Ticketshop",
        "Ihr Online-Kauf bei der SBB",
        "EasyRide Kaufquittung"
    };

    private string dateMode = "Year";
    private int selectedYear = DateTime.Now.Year;
    private DateOnly startDate = DateOnly.FromDateTime(DateTime.Now.AddMonths(-1));
    private DateOnly endDate = DateOnly.FromDateTime(DateTime.Now);
    private string subjectFilterInput = string.Empty;
    private List<string> subjectFilters = new List<string>();
    
    private bool isAuthenticated = false;
    private bool isLoaded = false;
    private string userName = string.Empty;
    private bool isLoading = false;
    private bool isPdfGenerating = false;
    private string errorMessage = string.Empty;
    private List<EmailSearchResult>? searchResults = null;

    protected override async Task OnInitializedAsync()
    {
        // Check if this is the first request after server restart
        if (StartupService.IsFirstRequestAfterStartup())
        {
            // Force logout to clear any stale authentication
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                Console.WriteLine("[Home] Server restart detected - forcing logout");
                Navigation.NavigateTo("Account/Logout", forceLoad: true);
                return;
            }
        }

        var authState2 = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState2.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userName = user.Identity?.Name ?? "Unknown";
        isLoaded = true;
    }

    private void HandleLogout()
    {
        Navigation.NavigateTo("Account/Logout", forceLoad: true);
    }

    private void AddSubjectFilter()
    {
        var trimmed = subjectFilterInput.Trim();
        if (!string.IsNullOrWhiteSpace(trimmed) && !subjectFilters.Contains(trimmed))
        {
            subjectFilters.Add(trimmed);
            subjectFilterInput = string.Empty;
        }
    }

    private void RemoveSubjectFilter(string filter)
    {
        subjectFilters.Remove(filter);
    }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(subjectFilterInput))
        {
            AddSubjectFilter();
        }
    }

    private void AddDefaultFilters()
    {
        foreach (var filter in defaultFilters)
        {
            if (!subjectFilters.Contains(filter))
            {
                subjectFilters.Add(filter);
            }
        }
    }

    private async Task SearchEmails()
    {
        isLoading = true;
        searchResults = null;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Calculate date range based on mode
            DateTime searchStart, searchEnd;
            
            if (dateMode == "Year")
            {
                searchStart = new DateTime(selectedYear, 1, 1);
                searchEnd = new DateTime(selectedYear, 12, 31, 23, 59, 59);
            }
            else
            {
                searchStart = startDate.ToDateTime(TimeOnly.MinValue);
                searchEnd = endDate.ToDateTime(new TimeOnly(23, 59, 59));
            }

            // Get access token
            var scopes = new[] { "https://graph.microsoft.com/Mail.Read" };
            var accessToken = await TokenAcquisition.GetAccessTokenForUserAsync(scopes);

            // Search emails
            searchResults = await EmailService.SearchEmailsAsync(
                accessToken, 
                searchStart, 
                searchEnd, 
                subjectFilters.Any() ? subjectFilters : null
            );
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string CalculateTotal()
    {
        if (searchResults == null || !searchResults.Any())
            return "0.00";

        decimal total = 0;
        foreach (var email in searchResults)
        {
            if (!string.IsNullOrEmpty(email.Amount))
            {
                // Parse amount, handling both . and ' as thousand separators
                var cleanAmount = email.Amount.Replace("'", "").Replace(",", ".");
                if (decimal.TryParse(cleanAmount, out var amount))
                {
                    total += amount;
                }
            }
        }
        return total.ToString("N2");
    }

    private async Task GenerateCsv()
    {
        if (searchResults == null || !searchResults.Any())
            return;

        var csv = new StringBuilder();
        
        // Header
        csv.AppendLine("Date,Amount (CHF),Subject");
        
        // Data rows
        foreach (var email in searchResults)
        {
            var date = email.TransactionDate ?? email.ReceivedDateTime.ToString("dd.MM.yyyy");
            var amount = email.Amount ?? "0.00";
            var subject = email.Subject.Replace(",", ";"); // Escape commas in subject
            
            csv.AppendLine($"{date},{amount},\"{subject}\"");
        }
        
        // Total row
        csv.AppendLine($"TOTAL,{CalculateTotal()},");
        
        // Download via JavaScript
        var bytes = Encoding.UTF8.GetBytes(csv.ToString());
        var base64 = Convert.ToBase64String(bytes);
        var fileName = $"EasyRide_Report_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
    }

    private async Task GeneratePdf()
    {
        if (searchResults == null || !searchResults.Any())
            return;

        isPdfGenerating = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Get access token
            var scopes = new[] { "https://graph.microsoft.com/Mail.Read" };
            var accessToken = await TokenAcquisition.GetAccessTokenForUserAsync(scopes);

            // Generate ZIP file with all PDFs
            var zipBytes = await EmailService.GenerateMergedPdfReportAsync(accessToken, searchResults);
            
            // Download via JavaScript
            var base64 = Convert.ToBase64String(zipBytes);
            var fileName = $"EasyRide_Report_{DateTime.Now:yyyyMMdd_HHmmss}.zip";
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
        }
        catch (Exception ex)
        {
            errorMessage = $"PDF generation failed: {ex.Message}";
        }
        finally
        {
            isPdfGenerating = false;
            StateHasChanged();
        }
    }
}
