@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Web
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<h1>SBB EasyRide – Tax Report</h1>

<hr />

<h3>Authentication</h3>

<p>Debug: isLoaded=@isLoaded, isAuthenticated=@isAuthenticated, userName=@userName</p>

@if (!isLoaded)
{
    <p>Loading...</p>
}
else if (isAuthenticated)
{
    <p>Welcome, @userName!</p>
    <button class="btn btn-secondary" @onclick="HandleLogout">Logout</button>
}
else
{
    <form method="get" action="MicrosoftIdentity/Account/SignIn">
        <button type="submit" class="btn btn-primary">Login</button>
    </form>
}

<hr />

<h3>Report Date Selection</h3>

<!-- DATE MODE TOGGLE -->
<div class="mb-3">
    <label class="form-label">Select date mode</label>

    <div class="d-flex gap-4">
        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Year")"
                   @onclick="@(() => dateMode = "Year")" />
            <label class="form-check-label">Year</label>
        </div>

        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Range")"
                   @onclick="@(() => dateMode = "Range")" />
            <label class="form-check-label">Specific date range</label>
        </div>
    </div>
</div>

<!-- INPUTS -->
<div class="d-flex gap-5 align-items-start">

    <!-- YEAR -->
    <div>
        <label class="form-label" style="@(dateMode != "Year" ? "text-decoration: line-through;" : "")">Year</label>
        <select class="form-select"
                style="max-width: 200px;"
                disabled="@(dateMode != "Year")">
            @for (int year = DateTime.Now.Year; year >= 1980; year--)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>

    <!-- DATE RANGE -->
    <div>
        <label class="form-label" style="@(dateMode != "Range" ? "text-decoration: line-through;" : "")">Date range</label>
        <div class="d-flex gap-2">
            <input type="date"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />

            <input type="date"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />
        </div>
    </div>

</div>

<hr />

<h3>Mail Settings</h3>

<div class="mb-3">
    <label class="form-label">Mail address</label>
    <input type="email"
           class="form-control"
           style="max-width: 400px;" />

    <div class="form-text">
        Sender address to filter by (e.g. noreply@order.info.sbb.ch)
    </div>
</div>

<div class="mb-3">
    <label class="form-label">Mail subject</label>
    <input type="text"
           class="form-control"
           style="max-width: 600px;" />

    <div class="form-text">
        Subject contains this text (e.g. EasyRide Kaufquittung)
    </div>
</div>

<hr />

<button class="btn btn-success btn-lg">
    Generate report
</button>

@code {
    private string dateMode = "Year"; // default
    private bool isAuthenticated = false;
    private bool isLoaded = false;
    private string userName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userName = user.Identity?.Name ?? "Unknown";
        isLoaded = true;
    }

    private void HandleLogout()
    {
        Navigation.NavigateTo("Account/Logout", forceLoad: true);
    }
}
