@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Identity.Web
@using SBB.EasyRide.TaxReport.Infrastructure.Services
@using SBB.EasyRide.TaxReport.Infrastructure.Models
@using SBB.EasyRide.TaxReport.Web.Services
@using System.Text
@using Microsoft.JSInterop
@using Microsoft.Extensions.Configuration
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ITokenAcquisition TokenAcquisition
@inject IEmailService EmailService
@inject StartupService StartupService
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<h1>SBB & ZVV Tax Report Generator</h1>

<hr />

@if (isConfigurationInvalid)
{
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">🔴 Configuration Error!</h4>
        @foreach (var error in configurationErrors)
        {
            <p><strong>@error</strong></p>
        }
        
        @if (configurationErrors.Any(e => e.Contains("expired")))
        {
            <h5>⚠️ Expired Client Secret</h5>
            @if (!string.IsNullOrEmpty(secretExpirationDate))
            {
                <p class="text-danger"><strong>Expired on: @secretExpirationDate</strong></p>
            }
        }
        
        <hr />
        <h5>How to configure:</h5>
        <hr />
        
        @if (configurationErrors.Any(e => e.Contains("ClientId")))
            {
                <p><strong>Get your ClientId from Azure Portal:</strong></p>
                <ul>
                    <li>Go to <a href="https://portal.azure.com" target="_blank">Azure Portal</a></li>
                    <li>Navigate to: <strong>Azure Active Directory → App registrations → Your app → Overview</strong></li>
                    <li>Copy the <strong>"Application (client) ID"</strong></li>
                </ul>
                @if (isRunningInDocker)
                {
                    <p>Update your <code>.env</code> file:</p>
                    <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">AZURE_CLIENT_ID=YOUR_CLIENT_ID</pre>
                }
                else
                {
                    <p>Open PowerShell in: <code>src\SBB.EasyRide.TaxReport.Web</code> and run:</p>
                    <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">dotnet user-secrets set "AzureAd:ClientId" "YOUR_CLIENT_ID"</pre>
                }
            <hr />
            }
            
            @if (configurationErrors.Any(e => e.Contains("TenantId")))
            {
                <p><strong>Set your TenantId:</strong></p>
                <p>Use <code>common</code> for personal Microsoft accounts, or copy your Tenant ID from Azure Portal for work accounts.</p>
                @if (isRunningInDocker)
                {
                    <p>Update your <code>.env</code> file:</p>
                    <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">AZURE_TENANT_ID=common</pre>
                }
                else
                {
                    <p>Open PowerShell in: <code>src\SBB.EasyRide.TaxReport.Web</code> and run:</p>
                    <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">dotnet user-secrets set "AzureAd:TenantId" "common"</pre>
                }
            <hr />
            }
            
            @if (configurationErrors.Any(e => e.Contains("ClientSecret")))
            {
                <p><strong>Create a new ClientSecret in Azure Portal:</strong></p>
                <ul>
                    <li>Go to <a href="https://portal.azure.com" target="_blank">Azure Portal</a></li>
                    <li>Navigate to: <strong>Azure Active Directory → App registrations → Your app → Certificates & secrets</strong></li>
                    <li>Click <strong>"New client secret"</strong> → Choose expiration period (e.g., 24 months) → Click <strong>"Add"</strong></li>
                    <li>Copy the <strong>Value</strong> immediately (it won't show again!) and note the <strong>Expires</strong> date</li>
                </ul>
                @if (isRunningInDocker)
                {
                    <p>Update your <code>.env</code> file:</p>
                    <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">AZURE_CLIENT_SECRET=YOUR_CLIENT_SECRET_VALUE
AZURE_CLIENT_SECRET_EXPIRATION=MM/DD/YYYY</pre>
                    <p><small><em>Example: "12/30/2027" (use the exact date format shown in Azure Portal)</em></small></p>
                }
                else
                {
                    <p>Open PowerShell in: <code>src\SBB.EasyRide.TaxReport.Web</code> and run:</p>
                    <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">dotnet user-secrets set "AzureAd:ClientSecret" "YOUR_CLIENT_SECRET_VALUE"
dotnet user-secrets set "AzureAd:ClientSecretExpiration" "MM/DD/YYYY"</pre>
                    <p><small><em>Example: "12/30/2027" (use the exact date format shown in Azure Portal)</em></small></p>
                }
            <hr />
            }
            
            @if (!isRunningInDocker)
            {
                <p><strong>View your current secrets:</strong></p>
                <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">dotnet user-secrets list</pre>
            }
            
            <p><strong>After making all changes above, restart the application:</strong></p>
            @if (isRunningInDocker)
            {
                <pre style="background-color: #f5f5f5; padding: 10px; border-radius: 4px;">docker compose down
docker compose up -d</pre>
            }
            else
            {
                <p>Run <code>dotnet run</code> from the <code>src\SBB.EasyRide.TaxReport.Web</code> folder</p>
            }
    </div>
}

<h3>Authentication</h3>

@if (!isLoaded)
{
    <p>Loading...</p>
}
else if (isAuthenticated)
{
    <p>Mail used for search: <strong>@userName</strong></p>
    <button class="btn btn-secondary" @onclick="HandleLogout">Logout</button>
}
else
{
    <form method="get" action="MicrosoftIdentity/Account/SignIn">
        <button type="submit" class="btn btn-primary">Login</button>
    </form>
}

<hr />

<h3>Report Date Selection</h3>

<!-- DATE MODE TOGGLE -->
<div class="mb-3">
    <label class="form-label">Select date mode</label>

    <div class="d-flex gap-4">
        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Year")"
                   @onclick="@(() => dateMode = "Year")" />
            <label class="form-check-label">Year</label>
        </div>

        <div class="form-check">
            <input class="form-check-input"
                   type="radio"
                   name="dateMode"
                   checked="@(dateMode == "Range")"
                   @onclick="@(() => dateMode = "Range")" />
            <label class="form-check-label">Specific date range</label>
        </div>
    </div>
</div>

<!-- INPUTS -->
<div class="d-flex gap-5 align-items-start">

    <!-- YEAR -->
    <div>
        <label class="form-label" style="@(dateMode != "Year" ? "text-decoration: line-through;" : "")">Year</label>
        <select class="form-select"
                @bind="selectedYear"
                style="max-width: 200px;"
                disabled="@(dateMode != "Year")">
            @for (int year = DateTime.Now.Year; year >= 2015; year--)
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>

    <!-- DATE RANGE -->
    <div>
        <label class="form-label" style="@(dateMode != "Range" ? "text-decoration: line-through;" : "")">Date range</label>
        <div class="d-flex gap-2">
            <input type="date"
                   @bind="startDate"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />

            <input type="date"
                   @bind="endDate"
                   class="form-control"
                   style="max-width: 200px;"
                   disabled="@(dateMode != "Range")" />
        </div>
        <small class="form-text text-muted">Both dates are inclusive</small>
    </div>

</div>

<hr />

<h3>Mail Settings</h3>

<div class="mb-3">
    <label class="form-label">Mail subject filters</label>
    <div class="input-group" style="max-width: 600px;">
        <input type="text"
               @bind="subjectFilterInput"
               @bind:event="oninput"
               @onkeypress="HandleKeyPress"
               class="form-control"/>
        <button class="btn btn-primary" @onclick="AddSubjectFilter" disabled="@string.IsNullOrWhiteSpace(subjectFilterInput)">
            Add
        </button>
    </div>
    <div class="form-text">
        Add subjects to search for (emails matching ANY of these will be included) <br/>
        <button class="btn btn-sm btn-info mt-1" @onclick="AddDefaultFilters">
            Add common filters: @string.Join(", ", defaultFilters)
        </button>
    </div>
</div>

@if (subjectFilters.Any())
{
    <div class="mb-3">
        <label class="form-label">Active filters:</label>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var filter in subjectFilters)
            {
                <span class="badge bg-secondary d-flex align-items-center gap-2" style="font-size: 1rem; padding: 0.5rem 0.75rem;">
                    @filter
                    <button type="button" class="btn-close btn-close-white" style="font-size: 0.7rem;" @onclick="() => RemoveSubjectFilter(filter)" aria-label="Remove"></button>
                </span>
            }
        </div>
        <button class="btn btn-sm btn-outline-danger mt-2" @onclick="ClearAllFilters">
            Clear All Filters
        </button>
    </div>
}

<hr />

<button class="btn btn-primary" @onclick="SearchEmails" disabled="@(!isAuthenticated || isLoading || !subjectFilters.Any())">
    @if (isLoading)
    {
        <span>Searching...</span>
    }
    else
    {
        <span>Search Emails</span>
    }
</button>

@if (isAuthenticated && !subjectFilters.Any())
{
    <div class="form-text mt-2 text-danger">
        <strong>Please add at least one subject filter before searching.</strong>
    </div>
}

<hr />

<h3>Search Results</h3>

@if (searchResults != null && searchResults.Any())
{
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSearchResults">
            Clear Search Results
        </button>
    </div>
    
    <div class="alert alert-success">
        <strong>Found @searchResults!.Count email(s)</strong>
    </div>
    
    @if (searchResults!.Count >= 75)
    {
        <div class="alert alert-warning" role="alert">
            <strong>⚠️ Result Limit Reached</strong><br/>
            The search has returned @searchResults!.Count emails, which may be hitting the API result limit. There could be additional emails matching your criteria that are not shown.
            <br/><br/>
            <strong>Suggestion:</strong> Try narrowing your search by using a shorter date range or more specific subject filters.
        </div>
    }
    
    <div class="mb-3">
        <button class="btn btn-success" @onclick="GenerateCsv" disabled="@(isLoading || isPdfGenerating)">
            Download CSV Report
        </button>
        <button class="btn btn-primary ms-2" @onclick="GeneratePdf" disabled="@(isLoading || isPdfGenerating)">
            @if (isPdfGenerating)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Generating PDF...</span>
            }
            else
            {
                <span>Generate Merged PDF Report</span>
            }
        </button>
    </div>
    
    @if (isPdfGenerating)
    {
        <div class="alert alert-info" role="alert">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>
                    <strong>Generating PDF report...</strong><br/>
                    <small>Processing @searchResults?.Count email(s) and merging PDF attachments. This may take a moment.</small>
                </div>
            </div>
        </div>
    }
    
    <div class="table-responsive">
        <table class="table table-striped table-bordered" style="width: auto;">
            <thead>
                <tr>
                    <th style="white-space: nowrap; padding: 8px 16px 8px 8px;">Received Date</th>
                    <th style="white-space: nowrap; padding: 8px 16px 8px 8px;">Transaction Date</th>
                    <th style="white-space: nowrap; padding: 8px 16px 8px 8px;">From</th>
                    <th style="padding: 8px 16px 8px 8px;">Subject</th>
                    <th class="text-end" style="white-space: nowrap; padding: 8px 8px 8px 16px;">Amount (CHF)</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var email in searchResults!)
                {
                    <tr>
                        <td style="white-space: nowrap; padding: 8px 16px 8px 8px;">@email.ReceivedDateTime.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</td>
                        <td style="white-space: nowrap; padding: 8px 16px 8px 8px;">@(email.TransactionDate ?? "-")</td>
                        <td style="white-space: nowrap; padding: 8px 16px 8px 8px;">@email.From</td>
                        <td style="max-width: 600px; word-wrap: break-word; word-break: break-word; padding: 8px 16px 8px 8px;">@email.Subject</td>
                        <td class="text-end" style="white-space: nowrap; padding: 8px 8px 8px 16px;">@(email.Amount ?? "-")</td>
                    </tr>
                }
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="4" class="text-end">Total:</th>
                    <th>CHF @CalculateTotal()</th>
                </tr>
            </tfoot>
        </table>
    </div>
}
else if (searchResults != null)
{
    <div class="alert alert-warning">
        <strong>No emails found matching your criteria</strong>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

<!-- Bottom spacing -->
<div style="margin-bottom: 3rem;"></div>

@code {
    private readonly string[] defaultFilters = new[] 
    {
        "Ihr Abo-Kauf im ZVV-Ticketshop",
        "Ihr Online-Kauf bei der SBB",
        "EasyRide Kaufquittung"
    };

    private string dateMode = "Year";
    private int selectedYear = DateTime.Now.Year - 1;
    private DateOnly startDate = new DateOnly(DateTime.Now.Year - 1, 1, 1);
    private DateOnly endDate = new DateOnly(DateTime.Now.Year - 1, 12, 31);
    private string subjectFilterInput = string.Empty;
    private List<string> subjectFilters = new List<string>();
    
    private bool isAuthenticated = false;
    private bool isLoaded = false;
    private string userName = string.Empty;
    private bool isLoading = false;
    private bool isPdfGenerating = false;
    private string errorMessage = string.Empty;
    private bool isConfigurationInvalid = false;
    private List<string> configurationErrors = new List<string>();
    private string? secretExpirationDate = null;
    private List<EmailSearchResult>? searchResults = null;
    private bool isRunningInDocker = false;

    protected override async Task OnInitializedAsync()
    {
        // Detect if running in Docker
        isRunningInDocker = Environment.GetEnvironmentVariable("DOTNET_RUNNING_IN_CONTAINER") == "true";
        
        // Check if configuration is valid
        CheckConfiguration();
        
        // Check if this is the first request after server restart
        if (StartupService.IsFirstRequestAfterStartup())
        {
            // Force logout to clear any stale authentication
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                Console.WriteLine("[Home] Server restart detected - forcing logout");
                Navigation.NavigateTo("Account/Logout", forceLoad: true);
                return;
            }
        }

        var authState2 = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState2.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;
        userName = user.Identity?.Name ?? "Unknown";
        isLoaded = true;
    }

    private void HandleLogout()
    {
        Navigation.NavigateTo("Account/Logout", forceLoad: true);
    }

    private void AddSubjectFilter()
    {
        var trimmed = subjectFilterInput.Trim();
        if (!string.IsNullOrWhiteSpace(trimmed) && !subjectFilters.Contains(trimmed))
        {
            subjectFilters.Add(trimmed);
            subjectFilterInput = string.Empty;
        }
    }

    private void RemoveSubjectFilter(string filter)
    {
        subjectFilters.Remove(filter);
    }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(subjectFilterInput))
        {
            AddSubjectFilter();
        }
    }

    private void AddDefaultFilters()
    {
        foreach (var filter in defaultFilters)
        {
            if (!subjectFilters.Contains(filter))
            {
                subjectFilters.Add(filter);
            }
        }
    }

    private void ClearAllFilters()
    {
        subjectFilters.Clear();
    }

    private void ClearSearchResults()
    {
        searchResults = null;
        errorMessage = string.Empty;
    }

    private async Task SearchEmails()
    {
        isLoading = true;
        searchResults = null;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Calculate date range based on mode
            DateTime searchStart, searchEnd;
            
            if (dateMode == "Year")
            {
                searchStart = new DateTime(selectedYear, 1, 1);
                searchEnd = new DateTime(selectedYear, 12, 31, 23, 59, 59);
            }
            else
            {
                searchStart = startDate.ToDateTime(TimeOnly.MinValue);
                searchEnd = endDate.ToDateTime(new TimeOnly(23, 59, 59));
            }

            // Get access token
            var scopes = new[] { "https://graph.microsoft.com/Mail.Read" };
            var accessToken = await TokenAcquisition.GetAccessTokenForUserAsync(scopes);

            // Search emails
            searchResults = await EmailService.SearchEmailsAsync(
                accessToken, 
                searchStart, 
                searchEnd, 
                subjectFilters.Any() ? subjectFilters : null
            );
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string CalculateTotal()
    {
        if (searchResults == null || !searchResults.Any())
            return "0.00";

        decimal total = 0;
        foreach (var email in searchResults)
        {
            if (!string.IsNullOrEmpty(email.Amount))
            {
                // Parse amount, handling both . and ' as thousand separators
                var cleanAmount = email.Amount.Replace("'", "").Replace(",", ".");
                if (decimal.TryParse(cleanAmount, out var amount))
                {
                    total += amount;
                }
            }
        }
        return total.ToString("N2");
    }

    private async Task GenerateCsv()
    {
        if (searchResults == null || !searchResults.Any())
            return;

        var csv = new StringBuilder();
        
        // Header
        csv.AppendLine("Date,Amount (CHF),Subject");
        
        // Data rows
        foreach (var email in searchResults)
        {
            var date = email.TransactionDate ?? email.ReceivedDateTime.ToString("dd.MM.yyyy");
            // Clean amount: remove all non-numeric characters except decimal point
            var amount = email.Amount ?? "0.00";
            amount = new string(amount.Where(c => char.IsDigit(c) || c == '.').ToArray());
            if (string.IsNullOrEmpty(amount)) amount = "0.00";
            
            var subject = email.Subject.Replace(",", ";"); // Escape commas in subject
            
            csv.AppendLine($"{date},{amount},\"{subject}\"");
        }
        
        // Total row - clean it as well
        var total = CalculateTotal();
        var cleanTotal = new string(total.Where(c => char.IsDigit(c) || c == '.').ToArray());
        if (string.IsNullOrEmpty(cleanTotal)) cleanTotal = "0.00";
        csv.AppendLine($"TOTAL,{cleanTotal},");
        
        // Download via JavaScript
        var bytes = Encoding.UTF8.GetBytes(csv.ToString());
        var base64 = Convert.ToBase64String(bytes);
        var fileName = $"EasyRide_Report_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
        
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
    }

    private async Task GeneratePdf()
    {
        if (searchResults == null || !searchResults.Any())
            return;

        isPdfGenerating = true;
        errorMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Get access token
            var scopes = new[] { "https://graph.microsoft.com/Mail.Read" };
            var accessToken = await TokenAcquisition.GetAccessTokenForUserAsync(scopes);

            // Generate ZIP file with all PDFs
            var zipBytes = await EmailService.GenerateMergedPdfReportAsync(accessToken, searchResults);
            
            // Download via JavaScript
            var base64 = Convert.ToBase64String(zipBytes);
            var fileName = $"EasyRide_Report_{DateTime.Now:yyyyMMdd_HHmmss}.zip";
            
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
        }
        catch (Exception ex)
        {
            errorMessage = $"PDF generation failed: {ex.Message}";
        }
        finally
        {
            isPdfGenerating = false;
            StateHasChanged();
        }
    }

    private void CheckConfiguration()
    {
        // Clear previous errors
        configurationErrors.Clear();
        isConfigurationInvalid = false;
        secretExpirationDate = null;
        
        // Check if required secrets are set
        var clientId = Configuration["AzureAd:ClientId"];
        var clientSecret = Configuration["AzureAd:ClientSecret"];
        var tenantId = Configuration["AzureAd:TenantId"];
        
        if (string.IsNullOrWhiteSpace(clientId) 
            || clientId == "WILL_BE_SET_IN_USER_SECRETS" 
            || clientId == "YOUR_CLIENT_ID_HERE"
            || clientId == "PLACEHOLDER_CLIENT_ID")
        {
            configurationErrors.Add("- Azure AD ClientId is not configured.");
        }
        
        // Check if client secret is expired first (before checking if it's configured)
        var expirationDateStr = Configuration["AzureAd:ClientSecretExpiration"];
        bool isSecretExpired = false;
        
        if (!string.IsNullOrEmpty(expirationDateStr)
            && expirationDateStr != "WILL_BE_SET_IN_USER_SECRETS"
            && expirationDateStr != "YOUR_CLIENT_SECRET_EXPIRATION_HERE"
            && expirationDateStr != "PLACEHOLDER_CLIENT_SECRET_EXPIRATION"
            && expirationDateStr != "MM/DD/YYYY")
        {
            // Try to parse with InvariantCulture to handle MM/DD/YYYY format from Azure Portal
            if (DateTime.TryParse(expirationDateStr, System.Globalization.CultureInfo.InvariantCulture, System.Globalization.DateTimeStyles.None, out var expirationDate))
            {
                if (DateTime.Now > expirationDate)
                {
                    configurationErrors.Add("- Azure AD ClientSecret has expired.");
                    secretExpirationDate = expirationDateStr;
                    isSecretExpired = true;
                }
            }
        }
        
        // Check if ClientSecret needs to be configured (not set OR expired)
        if (string.IsNullOrWhiteSpace(clientSecret) 
            || clientSecret == "WILL_BE_SET_IN_USER_SECRETS" 
            || clientSecret == "YOUR_CLIENT_SECRET_HERE"
            || clientSecret == "PLACEHOLDER_CLIENT_SECRET"
            || isSecretExpired)
        {
            // Only add this error if we haven't already added the expiration error
            // (to avoid saying both "expired" and "not configured" for the same secret)
            if (!isSecretExpired)
            {
                configurationErrors.Add("- Azure AD ClientSecret is not configured.");
            }
            else
            {
                configurationErrors.Add("- Azure AD ClientSecret needs to be replaced with a new secret.");
            }
        }
        
        if (string.IsNullOrWhiteSpace(tenantId)
            || tenantId == "WILL_BE_SET_IN_USER_SECRETS"
            || tenantId == "YOUR_TENANT_ID_HERE"
            || tenantId == "PLACEHOLDER_TENANT_ID")
        {
            configurationErrors.Add("- Azure AD TenantId is not configured.");
        }
        
        // Set the invalid flag if any errors were found
        if (configurationErrors.Any())
        {
            isConfigurationInvalid = true;
        }
    }
}
